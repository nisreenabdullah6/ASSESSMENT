{
 "cells": [
  {
   "cell_type": "code",
   "execution_count": 2,
   "id": "b6f7833a-f866-4928-9bca-962bb68832ce",
   "metadata": {},
   "outputs": [],
   "source": [
    "import pandas as pd\n",
    "import numpy as np\n",
    "\n",
    "from sentence_transformers import SentenceTransformer\n",
    "import faiss"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 3,
   "id": "e7fcf199-97e3-44ba-ae3b-32d1eb6247eb",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "<class 'pandas.core.frame.DataFrame'>\n",
      "RangeIndex: 12684 entries, 0 to 12683\n",
      "Data columns (total 18 columns):\n",
      " #   Column                   Non-Null Count  Dtype         \n",
      "---  ------                   --------------  -----         \n",
      " 0   encounter_id             12684 non-null  int64         \n",
      " 1   patient_id               12684 non-null  int64         \n",
      " 2   name                     12684 non-null  object        \n",
      " 3   Gender                   18 non-null     object        \n",
      " 4   doctor_id                12684 non-null  int64         \n",
      " 5   doctor_name              12684 non-null  object        \n",
      " 6   hospital_id              12684 non-null  int64         \n",
      " 7   hospital_name            12684 non-null  object        \n",
      " 8   insurance_provider_id    12684 non-null  int64         \n",
      " 9   insurance_provider_name  12684 non-null  object        \n",
      " 10  MedicalCondition         12684 non-null  object        \n",
      " 11  admission_date           12684 non-null  datetime64[ns]\n",
      " 12  discharge_date           12684 non-null  datetime64[ns]\n",
      " 13  billing_amount           12684 non-null  float64       \n",
      " 14  admission_type           12684 non-null  object        \n",
      " 15  medication               12684 non-null  object        \n",
      " 16  test_resultS             12684 non-null  object        \n",
      " 17  Length_of_Stay           2 non-null      float64       \n",
      "dtypes: datetime64[ns](2), float64(2), int64(5), object(9)\n",
      "memory usage: 1.7+ MB\n"
     ]
    },
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>encounter_id</th>\n",
       "      <th>patient_id</th>\n",
       "      <th>name</th>\n",
       "      <th>Gender</th>\n",
       "      <th>doctor_id</th>\n",
       "      <th>doctor_name</th>\n",
       "      <th>hospital_id</th>\n",
       "      <th>hospital_name</th>\n",
       "      <th>insurance_provider_id</th>\n",
       "      <th>insurance_provider_name</th>\n",
       "      <th>MedicalCondition</th>\n",
       "      <th>admission_date</th>\n",
       "      <th>discharge_date</th>\n",
       "      <th>billing_amount</th>\n",
       "      <th>admission_type</th>\n",
       "      <th>medication</th>\n",
       "      <th>test_resultS</th>\n",
       "      <th>Length_of_Stay</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>count</th>\n",
       "      <td>12684.000000</td>\n",
       "      <td>1.268400e+04</td>\n",
       "      <td>12684</td>\n",
       "      <td>18</td>\n",
       "      <td>12684.000000</td>\n",
       "      <td>12684</td>\n",
       "      <td>12684.000000</td>\n",
       "      <td>12684</td>\n",
       "      <td>12684.000000</td>\n",
       "      <td>12684</td>\n",
       "      <td>12684</td>\n",
       "      <td>12684</td>\n",
       "      <td>12684</td>\n",
       "      <td>12684.000000</td>\n",
       "      <td>12684</td>\n",
       "      <td>12684</td>\n",
       "      <td>12684</td>\n",
       "      <td>2.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>unique</th>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "      <td>9685</td>\n",
       "      <td>2</td>\n",
       "      <td>NaN</td>\n",
       "      <td>32</td>\n",
       "      <td>NaN</td>\n",
       "      <td>7</td>\n",
       "      <td>NaN</td>\n",
       "      <td>7</td>\n",
       "      <td>6</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "      <td>3</td>\n",
       "      <td>7</td>\n",
       "      <td>3</td>\n",
       "      <td>NaN</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>top</th>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "      <td>أروى الحكير</td>\n",
       "      <td>F</td>\n",
       "      <td>NaN</td>\n",
       "      <td>الدكتور خالد الخلف</td>\n",
       "      <td>NaN</td>\n",
       "      <td>مستشفى النور الطبي</td>\n",
       "      <td>NaN</td>\n",
       "      <td>شركة الوفاء الوطنية للتأمين</td>\n",
       "      <td>Arthritis</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "      <td>Emergency</td>\n",
       "      <td>Paracetamol</td>\n",
       "      <td>Inconclusive</td>\n",
       "      <td>NaN</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>freq</th>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "      <td>6</td>\n",
       "      <td>10</td>\n",
       "      <td>NaN</td>\n",
       "      <td>1740</td>\n",
       "      <td>NaN</td>\n",
       "      <td>1875</td>\n",
       "      <td>NaN</td>\n",
       "      <td>1855</td>\n",
       "      <td>2533</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "      <td>4952</td>\n",
       "      <td>5466</td>\n",
       "      <td>5113</td>\n",
       "      <td>NaN</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>mean</th>\n",
       "      <td>55889.022233</td>\n",
       "      <td>1.049814e+07</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "      <td>19263.399558</td>\n",
       "      <td>NaN</td>\n",
       "      <td>1233.986203</td>\n",
       "      <td>NaN</td>\n",
       "      <td>16258.025386</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "      <td>2023-11-17 08:38:29.176915968</td>\n",
       "      <td>2023-11-25 23:01:52.393566720</td>\n",
       "      <td>57558.776180</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "      <td>14.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>min</th>\n",
       "      <td>19253.000000</td>\n",
       "      <td>1.000010e+07</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "      <td>19251.000000</td>\n",
       "      <td>NaN</td>\n",
       "      <td>1231.000000</td>\n",
       "      <td>NaN</td>\n",
       "      <td>16255.000000</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "      <td>2018-11-21 00:00:00</td>\n",
       "      <td>2022-10-26 00:00:00</td>\n",
       "      <td>512.520000</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "      <td>14.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>25%</th>\n",
       "      <td>37528.500000</td>\n",
       "      <td>1.025076e+07</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "      <td>19254.000000</td>\n",
       "      <td>NaN</td>\n",
       "      <td>1232.000000</td>\n",
       "      <td>NaN</td>\n",
       "      <td>16256.000000</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "      <td>2023-10-28 00:00:00</td>\n",
       "      <td>2023-11-04 00:00:00</td>\n",
       "      <td>28367.221250</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "      <td>14.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>50%</th>\n",
       "      <td>56047.500000</td>\n",
       "      <td>1.050083e+07</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "      <td>19261.000000</td>\n",
       "      <td>NaN</td>\n",
       "      <td>1234.000000</td>\n",
       "      <td>NaN</td>\n",
       "      <td>16258.000000</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "      <td>2023-11-18 00:00:00</td>\n",
       "      <td>2023-11-26 00:00:00</td>\n",
       "      <td>57582.360000</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "      <td>14.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>75%</th>\n",
       "      <td>74101.250000</td>\n",
       "      <td>1.074522e+07</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "      <td>19271.000000</td>\n",
       "      <td>NaN</td>\n",
       "      <td>1236.000000</td>\n",
       "      <td>NaN</td>\n",
       "      <td>16260.000000</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "      <td>2023-12-10 00:00:00</td>\n",
       "      <td>2023-12-17 00:00:00</td>\n",
       "      <td>86170.447500</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "      <td>14.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>max</th>\n",
       "      <td>92598.000000</td>\n",
       "      <td>1.099993e+07</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "      <td>19284.000000</td>\n",
       "      <td>NaN</td>\n",
       "      <td>1237.000000</td>\n",
       "      <td>NaN</td>\n",
       "      <td>16261.000000</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "      <td>2023-12-31 00:00:00</td>\n",
       "      <td>2024-01-19 00:00:00</td>\n",
       "      <td>614988.220000</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "      <td>14.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>std</th>\n",
       "      <td>21185.379706</td>\n",
       "      <td>2.869929e+05</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "      <td>10.177983</td>\n",
       "      <td>NaN</td>\n",
       "      <td>1.992784</td>\n",
       "      <td>NaN</td>\n",
       "      <td>2.000824</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "      <td>33536.232864</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "      <td>0.0</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "</div>"
      ],
      "text/plain": [
       "        encounter_id    patient_id         name Gender     doctor_id  \\\n",
       "count   12684.000000  1.268400e+04        12684     18  12684.000000   \n",
       "unique           NaN           NaN         9685      2           NaN   \n",
       "top              NaN           NaN  أروى الحكير      F           NaN   \n",
       "freq             NaN           NaN            6     10           NaN   \n",
       "mean    55889.022233  1.049814e+07          NaN    NaN  19263.399558   \n",
       "min     19253.000000  1.000010e+07          NaN    NaN  19251.000000   \n",
       "25%     37528.500000  1.025076e+07          NaN    NaN  19254.000000   \n",
       "50%     56047.500000  1.050083e+07          NaN    NaN  19261.000000   \n",
       "75%     74101.250000  1.074522e+07          NaN    NaN  19271.000000   \n",
       "max     92598.000000  1.099993e+07          NaN    NaN  19284.000000   \n",
       "std     21185.379706  2.869929e+05          NaN    NaN     10.177983   \n",
       "\n",
       "               doctor_name   hospital_id       hospital_name  \\\n",
       "count                12684  12684.000000               12684   \n",
       "unique                  32           NaN                   7   \n",
       "top     الدكتور خالد الخلف           NaN  مستشفى النور الطبي   \n",
       "freq                  1740           NaN                1875   \n",
       "mean                   NaN   1233.986203                 NaN   \n",
       "min                    NaN   1231.000000                 NaN   \n",
       "25%                    NaN   1232.000000                 NaN   \n",
       "50%                    NaN   1234.000000                 NaN   \n",
       "75%                    NaN   1236.000000                 NaN   \n",
       "max                    NaN   1237.000000                 NaN   \n",
       "std                    NaN      1.992784                 NaN   \n",
       "\n",
       "        insurance_provider_id      insurance_provider_name MedicalCondition  \\\n",
       "count            12684.000000                        12684            12684   \n",
       "unique                    NaN                            7                6   \n",
       "top                       NaN  شركة الوفاء الوطنية للتأمين        Arthritis   \n",
       "freq                      NaN                         1855             2533   \n",
       "mean             16258.025386                          NaN              NaN   \n",
       "min              16255.000000                          NaN              NaN   \n",
       "25%              16256.000000                          NaN              NaN   \n",
       "50%              16258.000000                          NaN              NaN   \n",
       "75%              16260.000000                          NaN              NaN   \n",
       "max              16261.000000                          NaN              NaN   \n",
       "std                  2.000824                          NaN              NaN   \n",
       "\n",
       "                       admission_date                 discharge_date  \\\n",
       "count                           12684                          12684   \n",
       "unique                            NaN                            NaN   \n",
       "top                               NaN                            NaN   \n",
       "freq                              NaN                            NaN   \n",
       "mean    2023-11-17 08:38:29.176915968  2023-11-25 23:01:52.393566720   \n",
       "min               2018-11-21 00:00:00            2022-10-26 00:00:00   \n",
       "25%               2023-10-28 00:00:00            2023-11-04 00:00:00   \n",
       "50%               2023-11-18 00:00:00            2023-11-26 00:00:00   \n",
       "75%               2023-12-10 00:00:00            2023-12-17 00:00:00   \n",
       "max               2023-12-31 00:00:00            2024-01-19 00:00:00   \n",
       "std                               NaN                            NaN   \n",
       "\n",
       "        billing_amount admission_type   medication  test_resultS  \\\n",
       "count     12684.000000          12684        12684         12684   \n",
       "unique             NaN              3            7             3   \n",
       "top                NaN      Emergency  Paracetamol  Inconclusive   \n",
       "freq               NaN           4952         5466          5113   \n",
       "mean      57558.776180            NaN          NaN           NaN   \n",
       "min         512.520000            NaN          NaN           NaN   \n",
       "25%       28367.221250            NaN          NaN           NaN   \n",
       "50%       57582.360000            NaN          NaN           NaN   \n",
       "75%       86170.447500            NaN          NaN           NaN   \n",
       "max      614988.220000            NaN          NaN           NaN   \n",
       "std       33536.232864            NaN          NaN           NaN   \n",
       "\n",
       "        Length_of_Stay  \n",
       "count              2.0  \n",
       "unique             NaN  \n",
       "top                NaN  \n",
       "freq               NaN  \n",
       "mean              14.0  \n",
       "min               14.0  \n",
       "25%               14.0  \n",
       "50%               14.0  \n",
       "75%               14.0  \n",
       "max               14.0  \n",
       "std                0.0  "
      ]
     },
     "execution_count": 3,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "# Adjust the path if needed\n",
    "claims = pd.read_excel(\"HealthCare_Claims.xlsx\")\n",
    "claims.head()\n",
    "claims.info()\n",
    "claims.describe(include='all')"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 4,
   "id": "25d0da09-8f1f-4551-9fa6-60ab73bd7dc0",
   "metadata": {},
   "outputs": [],
   "source": [
    "# Basic cleaning\n",
    "string_cols = claims.select_dtypes(include=[\"object\"]).columns.tolist()\n",
    "num_cols = claims.select_dtypes(include=[\"int64\", \"float64\"]).columns.tolist()\n",
    "\n",
    "claims[string_cols] = claims[string_cols].fillna(\"\")\n",
    "claims[num_cols] = claims[num_cols].fillna(0)\n",
    "\n",
    "# Convert dates to string (optional, for text)\n",
    "if \"admission_date\" in claims.columns:\n",
    "    claims[\"admission_date\"] = claims[\"admission_date\"].astype(str)\n",
    "if \"discharge_date\" in claims.columns:\n",
    "    claims[\"discharge_date\"] = claims[\"discharge_date\"].astype(str)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 5,
   "id": "365776c6-21cd-4d23-ab63-5021121ca6aa",
   "metadata": {},
   "outputs": [],
   "source": [
    "def encounter_to_text(row):\n",
    "    \"\"\"\n",
    "    Convert one medical claim encounter into a descriptive text.\n",
    "    \"\"\"\n",
    "    parts = []\n",
    "    parts.append(f\"Encounter ID: {row['encounter_id']}.\")\n",
    "    parts.append(f\" Patient ID: {row['patient_id']}.\")\n",
    "    parts.append(f\" Patient name: {row['name']}.\")\n",
    "    parts.append(f\" Gender: {row['Gender']}.\")\n",
    "    parts.append(f\" Doctor ID: {row['doctor_id']}.\")\n",
    "    parts.append(f\" Doctor name: {row['doctor_name']}.\")\n",
    "    parts.append(f\" Hospital name: {row['hospital_name']}.\")\n",
    "    parts.append(f\" Insurance provider name: {row['insurance_provider_name']}.\")\n",
    "    parts.append(f\" Medical condition: {row['MedicalCondition']}.\")\n",
    "    parts.append(f\" Admission date: {row['admission_date']}.\")\n",
    "    parts.append(f\" Discharge date: {row['discharge_date']}.\")\n",
    "    parts.append(f\" Billing amount: {row['billing_amount']}.\")\n",
    "    parts.append(f\" Admission type: {row['admission_type']}.\")\n",
    "    parts.append(f\" Medication: {row['medication']}.\")\n",
    "    parts.append(f\" Test results: {row['test_resultS']}.\")\n",
    "    parts.append(f\" Length of stay: {row['Length_of_Stay']}.\")\n",
    "    return \" \".join(parts)\n",
    "\n",
    "claims[\"doc_text\"] = claims.apply(encounter_to_text, axis=1)\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 6,
   "id": "4aab2863-421a-49be-9683-e7618beec562",
   "metadata": {},
   "outputs": [
    {
     "data": {
      "application/vnd.jupyter.widget-view+json": {
       "model_id": "4de0dc89dc774a4d996d7c9da29f4e29",
       "version_major": 2,
       "version_minor": 0
      },
      "text/plain": [
       "Batches:   0%|          | 0/397 [00:00<?, ?it/s]"
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "FAISS index built with 12684 documents.\n"
     ]
    }
   ],
   "source": [
    "from sentence_transformers import SentenceTransformer\n",
    "import faiss\n",
    "import numpy as np\n",
    "\n",
    "# Load embedding model\n",
    "embed_model = SentenceTransformer(\"all-MiniLM-L6-v2\")\n",
    "\n",
    "# Encode all encounter documents\n",
    "doc_texts = claims[\"doc_text\"].tolist()\n",
    "doc_embeddings = embed_model.encode(doc_texts, show_progress_bar=True)\n",
    "doc_embeddings = np.array(doc_embeddings).astype(\"float32\")\n",
    "\n",
    "# Build FAISS index\n",
    "dim = doc_embeddings.shape[1]\n",
    "index = faiss.IndexFlatL2(dim)\n",
    "index.add(doc_embeddings)\n",
    "\n",
    "print(\"FAISS index built with\", index.ntotal, \"documents.\")\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 7,
   "id": "3360fb33-926c-4cda-92d4-46003b54e972",
   "metadata": {},
   "outputs": [],
   "source": [
    "def retrieve_top_k(query, k=5):\n",
    "    \"\"\"\n",
    "    Given a user query, retrieve top-k most similar encounters by embeddings.\n",
    "    \"\"\"\n",
    "    # 1) Encode the question as an embedding\n",
    "    query_emb = embed_model.encode([query]).astype(\"float32\")\n",
    "    \n",
    "    # 2) Search in FAISS for closest vectors\n",
    "    distances, indices = index.search(query_emb, k)\n",
    "    \n",
    "    # 3) Build a list of retrieved documents\n",
    "    results = []\n",
    "    for idx, dist in zip(indices[0], distances[0]):\n",
    "        row = claims.iloc[idx]\n",
    "        result = {\n",
    "            \"row_index\": int(idx),\n",
    "            \"distance\": float(dist),\n",
    "            \"encounter_id\": row[\"encounter_id\"],\n",
    "            \"patient_id\": row[\"patient_id\"],\n",
    "            \"doc_text\": row[\"doc_text\"]\n",
    "        }\n",
    "        results.append(result)\n",
    "    return results\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 9,
   "id": "ec67da18-c2c4-40ad-bae7-382a54ed5077",
   "metadata": {},
   "outputs": [],
   "source": [
    "def build_prompt(user_question, retrieved_docs):\n",
    "\n",
    "    # استخراج النصوص من السجلات المسترجعة\n",
    "    context_blocks = [d[\"doc_text\"] for d in retrieved_docs]\n",
    "    context_str = \"\\n\\n\".join(context_blocks)\n",
    "\n",
    "    system_prompt = (\n",
    "        \"You are a medical claims analysis assistant. \"\n",
    "        \"You MUST answer ONLY using the information from the provided encounters context. \"\n",
    "        \"If you cannot find the answer in the context, say that you cannot find it. \"\n",
    "        \"Do not invent or guess any values.\"\n",
    "    )\n",
    "\n",
    "    final_prompt = (\n",
    "        system_prompt\n",
    "        + \"\\n\\n=== Encounters Context ===\\n\"\n",
    "        + context_str\n",
    "        + \"\\n\\n=== User Question ===\\n\"\n",
    "        + user_question\n",
    "        + \"\\n\\nAnswer clearly in English.\\n\"\n",
    "    )\n",
    "\n",
    "    return final_prompt\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 27,
   "id": "bea1c0ee-1b95-49a5-a59f-dd872bb046a7",
   "metadata": {},
   "outputs": [],
   "source": [
    "from openai import OpenAI\n",
    "import os\n",
    "\n",
    "client = OpenAI(api_key=\"",
    "\n",
    "\n",
    "def call_llm(prompt: str) -> str:\n",
    "    \n",
    "    response = client.chat.completions.create(\n",
    "        model=\"gpt-4.1-mini\",  \n",
    "        messages=[\n",
    "            {\"role\": \"user\", \"content\": prompt}\n",
    "        ]\n",
    "    )\n",
    "\n",
    "    return response.choices[0].message.content\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 28,
   "id": "03fa478b-32ff-458a-862f-8a74041ce54c",
   "metadata": {},
   "outputs": [],
   "source": [
    "def answer_question(user_question: str, k: int = 5): \n",
    "    \n",
    "    retrieved_docs = retrieve_top_k(user_question, k=k) \n",
    "    prompt = build_prompt(user_question, retrieved_docs) \n",
    "    answer = call_llm(prompt) \n",
    "    return answer, retrieved_docs"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 29,
   "id": "0e58a61c-a7c5-4db4-aed7-eb235e99f56a",
   "metadata": {},
   "outputs": [],
   "source": [
    "def simple_demo(): \n",
    "    q = \"What is the billing amount and length of stay for encounter 1?\" \n",
    "    try: \n",
    "        answer, docs = answer_question(q, k=5) \n",
    "        print(\"Question:\", q) \n",
    "        print(\"\\nRetrieved context (first encounter):\\n\") \n",
    "        print(docs[0][\"doc_text\"]) \n",
    "        print(\"\\nLLM answer:\\n\", answer) \n",
    "    except NotImplementedError: \n",
    "        print(\"Please implement call_llm() to use the LLM.\") "
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 30,
   "id": "94e93e61-7968-4830-a243-8fdf37622c5e",
   "metadata": {},
   "outputs": [
    {
     "ename": "RateLimitError",
     "evalue": "Error code: 429 - {'error': {'message': 'You exceeded your current quota, please check your plan and billing details. For more information on this error, read the docs: https://platform.openai.com/docs/guides/error-codes/api-errors.', 'type': 'insufficient_quota', 'param': None, 'code': 'insufficient_quota'}}",
     "output_type": "error",
     "traceback": [
      "\u001b[1;31m---------------------------------------------------------------------------\u001b[0m",
      "\u001b[1;31mRateLimitError\u001b[0m                            Traceback (most recent call last)",
      "Cell \u001b[1;32mIn[30], line 1\u001b[0m\n\u001b[1;32m----> 1\u001b[0m simple_demo()\n",
      "Cell \u001b[1;32mIn[29], line 4\u001b[0m, in \u001b[0;36msimple_demo\u001b[1;34m()\u001b[0m\n\u001b[0;32m      2\u001b[0m q \u001b[38;5;241m=\u001b[39m \u001b[38;5;124m\"\u001b[39m\u001b[38;5;124mWhat is the billing amount and length of stay for encounter 1?\u001b[39m\u001b[38;5;124m\"\u001b[39m \n\u001b[0;32m      3\u001b[0m \u001b[38;5;28;01mtry\u001b[39;00m: \n\u001b[1;32m----> 4\u001b[0m     answer, docs \u001b[38;5;241m=\u001b[39m answer_question(q, k\u001b[38;5;241m=\u001b[39m\u001b[38;5;241m5\u001b[39m) \n\u001b[0;32m      5\u001b[0m     \u001b[38;5;28mprint\u001b[39m(\u001b[38;5;124m\"\u001b[39m\u001b[38;5;124mQuestion:\u001b[39m\u001b[38;5;124m\"\u001b[39m, q) \n\u001b[0;32m      6\u001b[0m     \u001b[38;5;28mprint\u001b[39m(\u001b[38;5;124m\"\u001b[39m\u001b[38;5;130;01m\\n\u001b[39;00m\u001b[38;5;124mRetrieved context (first encounter):\u001b[39m\u001b[38;5;130;01m\\n\u001b[39;00m\u001b[38;5;124m\"\u001b[39m) \n",
      "Cell \u001b[1;32mIn[28], line 5\u001b[0m, in \u001b[0;36manswer_question\u001b[1;34m(user_question, k)\u001b[0m\n\u001b[0;32m      3\u001b[0m retrieved_docs \u001b[38;5;241m=\u001b[39m retrieve_top_k(user_question, k\u001b[38;5;241m=\u001b[39mk) \n\u001b[0;32m      4\u001b[0m prompt \u001b[38;5;241m=\u001b[39m build_prompt(user_question, retrieved_docs) \n\u001b[1;32m----> 5\u001b[0m answer \u001b[38;5;241m=\u001b[39m call_llm(prompt) \n\u001b[0;32m      6\u001b[0m \u001b[38;5;28;01mreturn\u001b[39;00m answer, retrieved_docs\n",
      "Cell \u001b[1;32mIn[27], line 12\u001b[0m, in \u001b[0;36mcall_llm\u001b[1;34m(prompt)\u001b[0m\n\u001b[0;32m      8\u001b[0m \u001b[38;5;28;01mdef\u001b[39;00m \u001b[38;5;21mcall_llm\u001b[39m(prompt: \u001b[38;5;28mstr\u001b[39m) \u001b[38;5;241m-\u001b[39m\u001b[38;5;241m>\u001b[39m \u001b[38;5;28mstr\u001b[39m:\n\u001b[0;32m      9\u001b[0m \u001b[38;5;250m    \u001b[39m\u001b[38;5;124;03m\"\"\"\u001b[39;00m\n\u001b[0;32m     10\u001b[0m \u001b[38;5;124;03m    تستدعي نموذج OpenAI GPT-4.1-mini لإجابة سؤال المستخدم.\u001b[39;00m\n\u001b[0;32m     11\u001b[0m \u001b[38;5;124;03m    \"\"\"\u001b[39;00m\n\u001b[1;32m---> 12\u001b[0m     response \u001b[38;5;241m=\u001b[39m client\u001b[38;5;241m.\u001b[39mchat\u001b[38;5;241m.\u001b[39mcompletions\u001b[38;5;241m.\u001b[39mcreate(\n\u001b[0;32m     13\u001b[0m         model\u001b[38;5;241m=\u001b[39m\u001b[38;5;124m\"\u001b[39m\u001b[38;5;124mgpt-4.1-mini\u001b[39m\u001b[38;5;124m\"\u001b[39m,   \u001b[38;5;66;03m# الموديل الفعلي\u001b[39;00m\n\u001b[0;32m     14\u001b[0m         messages\u001b[38;5;241m=\u001b[39m[\n\u001b[0;32m     15\u001b[0m             {\u001b[38;5;124m\"\u001b[39m\u001b[38;5;124mrole\u001b[39m\u001b[38;5;124m\"\u001b[39m: \u001b[38;5;124m\"\u001b[39m\u001b[38;5;124muser\u001b[39m\u001b[38;5;124m\"\u001b[39m, \u001b[38;5;124m\"\u001b[39m\u001b[38;5;124mcontent\u001b[39m\u001b[38;5;124m\"\u001b[39m: prompt}\n\u001b[0;32m     16\u001b[0m         ]\n\u001b[0;32m     17\u001b[0m     )\n\u001b[0;32m     19\u001b[0m     \u001b[38;5;66;03m# استخراج نص الإجابة\u001b[39;00m\n\u001b[0;32m     20\u001b[0m     \u001b[38;5;28;01mreturn\u001b[39;00m response\u001b[38;5;241m.\u001b[39mchoices[\u001b[38;5;241m0\u001b[39m]\u001b[38;5;241m.\u001b[39mmessage\u001b[38;5;241m.\u001b[39mcontent\n",
      "File \u001b[1;32m~\\anaconda3\\Lib\\site-packages\\openai\\_utils\\_utils.py:286\u001b[0m, in \u001b[0;36mrequired_args.<locals>.inner.<locals>.wrapper\u001b[1;34m(*args, **kwargs)\u001b[0m\n\u001b[0;32m    284\u001b[0m             msg \u001b[38;5;241m=\u001b[39m \u001b[38;5;124mf\u001b[39m\u001b[38;5;124m\"\u001b[39m\u001b[38;5;124mMissing required argument: \u001b[39m\u001b[38;5;132;01m{\u001b[39;00mquote(missing[\u001b[38;5;241m0\u001b[39m])\u001b[38;5;132;01m}\u001b[39;00m\u001b[38;5;124m\"\u001b[39m\n\u001b[0;32m    285\u001b[0m     \u001b[38;5;28;01mraise\u001b[39;00m \u001b[38;5;167;01mTypeError\u001b[39;00m(msg)\n\u001b[1;32m--> 286\u001b[0m \u001b[38;5;28;01mreturn\u001b[39;00m func(\u001b[38;5;241m*\u001b[39margs, \u001b[38;5;241m*\u001b[39m\u001b[38;5;241m*\u001b[39mkwargs)\n",
      "File \u001b[1;32m~\\anaconda3\\Lib\\site-packages\\openai\\resources\\chat\\completions\\completions.py:1189\u001b[0m, in \u001b[0;36mCompletions.create\u001b[1;34m(self, messages, model, audio, frequency_penalty, function_call, functions, logit_bias, logprobs, max_completion_tokens, max_tokens, metadata, modalities, n, parallel_tool_calls, prediction, presence_penalty, prompt_cache_key, prompt_cache_retention, reasoning_effort, response_format, safety_identifier, seed, service_tier, stop, store, stream, stream_options, temperature, tool_choice, tools, top_logprobs, top_p, user, verbosity, web_search_options, extra_headers, extra_query, extra_body, timeout)\u001b[0m\n\u001b[0;32m   1142\u001b[0m \u001b[38;5;129m@required_args\u001b[39m([\u001b[38;5;124m\"\u001b[39m\u001b[38;5;124mmessages\u001b[39m\u001b[38;5;124m\"\u001b[39m, \u001b[38;5;124m\"\u001b[39m\u001b[38;5;124mmodel\u001b[39m\u001b[38;5;124m\"\u001b[39m], [\u001b[38;5;124m\"\u001b[39m\u001b[38;5;124mmessages\u001b[39m\u001b[38;5;124m\"\u001b[39m, \u001b[38;5;124m\"\u001b[39m\u001b[38;5;124mmodel\u001b[39m\u001b[38;5;124m\"\u001b[39m, \u001b[38;5;124m\"\u001b[39m\u001b[38;5;124mstream\u001b[39m\u001b[38;5;124m\"\u001b[39m])\n\u001b[0;32m   1143\u001b[0m \u001b[38;5;28;01mdef\u001b[39;00m \u001b[38;5;21mcreate\u001b[39m(\n\u001b[0;32m   1144\u001b[0m     \u001b[38;5;28mself\u001b[39m,\n\u001b[1;32m   (...)\u001b[0m\n\u001b[0;32m   1186\u001b[0m     timeout: \u001b[38;5;28mfloat\u001b[39m \u001b[38;5;241m|\u001b[39m httpx\u001b[38;5;241m.\u001b[39mTimeout \u001b[38;5;241m|\u001b[39m \u001b[38;5;28;01mNone\u001b[39;00m \u001b[38;5;241m|\u001b[39m NotGiven \u001b[38;5;241m=\u001b[39m not_given,\n\u001b[0;32m   1187\u001b[0m ) \u001b[38;5;241m-\u001b[39m\u001b[38;5;241m>\u001b[39m ChatCompletion \u001b[38;5;241m|\u001b[39m Stream[ChatCompletionChunk]:\n\u001b[0;32m   1188\u001b[0m     validate_response_format(response_format)\n\u001b[1;32m-> 1189\u001b[0m     \u001b[38;5;28;01mreturn\u001b[39;00m \u001b[38;5;28mself\u001b[39m\u001b[38;5;241m.\u001b[39m_post(\n\u001b[0;32m   1190\u001b[0m         \u001b[38;5;124m\"\u001b[39m\u001b[38;5;124m/chat/completions\u001b[39m\u001b[38;5;124m\"\u001b[39m,\n\u001b[0;32m   1191\u001b[0m         body\u001b[38;5;241m=\u001b[39mmaybe_transform(\n\u001b[0;32m   1192\u001b[0m             {\n\u001b[0;32m   1193\u001b[0m                 \u001b[38;5;124m\"\u001b[39m\u001b[38;5;124mmessages\u001b[39m\u001b[38;5;124m\"\u001b[39m: messages,\n\u001b[0;32m   1194\u001b[0m                 \u001b[38;5;124m\"\u001b[39m\u001b[38;5;124mmodel\u001b[39m\u001b[38;5;124m\"\u001b[39m: model,\n\u001b[0;32m   1195\u001b[0m                 \u001b[38;5;124m\"\u001b[39m\u001b[38;5;124maudio\u001b[39m\u001b[38;5;124m\"\u001b[39m: audio,\n\u001b[0;32m   1196\u001b[0m                 \u001b[38;5;124m\"\u001b[39m\u001b[38;5;124mfrequency_penalty\u001b[39m\u001b[38;5;124m\"\u001b[39m: frequency_penalty,\n\u001b[0;32m   1197\u001b[0m                 \u001b[38;5;124m\"\u001b[39m\u001b[38;5;124mfunction_call\u001b[39m\u001b[38;5;124m\"\u001b[39m: function_call,\n\u001b[0;32m   1198\u001b[0m                 \u001b[38;5;124m\"\u001b[39m\u001b[38;5;124mfunctions\u001b[39m\u001b[38;5;124m\"\u001b[39m: functions,\n\u001b[0;32m   1199\u001b[0m                 \u001b[38;5;124m\"\u001b[39m\u001b[38;5;124mlogit_bias\u001b[39m\u001b[38;5;124m\"\u001b[39m: logit_bias,\n\u001b[0;32m   1200\u001b[0m                 \u001b[38;5;124m\"\u001b[39m\u001b[38;5;124mlogprobs\u001b[39m\u001b[38;5;124m\"\u001b[39m: logprobs,\n\u001b[0;32m   1201\u001b[0m                 \u001b[38;5;124m\"\u001b[39m\u001b[38;5;124mmax_completion_tokens\u001b[39m\u001b[38;5;124m\"\u001b[39m: max_completion_tokens,\n\u001b[0;32m   1202\u001b[0m                 \u001b[38;5;124m\"\u001b[39m\u001b[38;5;124mmax_tokens\u001b[39m\u001b[38;5;124m\"\u001b[39m: max_tokens,\n\u001b[0;32m   1203\u001b[0m                 \u001b[38;5;124m\"\u001b[39m\u001b[38;5;124mmetadata\u001b[39m\u001b[38;5;124m\"\u001b[39m: metadata,\n\u001b[0;32m   1204\u001b[0m                 \u001b[38;5;124m\"\u001b[39m\u001b[38;5;124mmodalities\u001b[39m\u001b[38;5;124m\"\u001b[39m: modalities,\n\u001b[0;32m   1205\u001b[0m                 \u001b[38;5;124m\"\u001b[39m\u001b[38;5;124mn\u001b[39m\u001b[38;5;124m\"\u001b[39m: n,\n\u001b[0;32m   1206\u001b[0m                 \u001b[38;5;124m\"\u001b[39m\u001b[38;5;124mparallel_tool_calls\u001b[39m\u001b[38;5;124m\"\u001b[39m: parallel_tool_calls,\n\u001b[0;32m   1207\u001b[0m                 \u001b[38;5;124m\"\u001b[39m\u001b[38;5;124mprediction\u001b[39m\u001b[38;5;124m\"\u001b[39m: prediction,\n\u001b[0;32m   1208\u001b[0m                 \u001b[38;5;124m\"\u001b[39m\u001b[38;5;124mpresence_penalty\u001b[39m\u001b[38;5;124m\"\u001b[39m: presence_penalty,\n\u001b[0;32m   1209\u001b[0m                 \u001b[38;5;124m\"\u001b[39m\u001b[38;5;124mprompt_cache_key\u001b[39m\u001b[38;5;124m\"\u001b[39m: prompt_cache_key,\n\u001b[0;32m   1210\u001b[0m                 \u001b[38;5;124m\"\u001b[39m\u001b[38;5;124mprompt_cache_retention\u001b[39m\u001b[38;5;124m\"\u001b[39m: prompt_cache_retention,\n\u001b[0;32m   1211\u001b[0m                 \u001b[38;5;124m\"\u001b[39m\u001b[38;5;124mreasoning_effort\u001b[39m\u001b[38;5;124m\"\u001b[39m: reasoning_effort,\n\u001b[0;32m   1212\u001b[0m                 \u001b[38;5;124m\"\u001b[39m\u001b[38;5;124mresponse_format\u001b[39m\u001b[38;5;124m\"\u001b[39m: response_format,\n\u001b[0;32m   1213\u001b[0m                 \u001b[38;5;124m\"\u001b[39m\u001b[38;5;124msafety_identifier\u001b[39m\u001b[38;5;124m\"\u001b[39m: safety_identifier,\n\u001b[0;32m   1214\u001b[0m                 \u001b[38;5;124m\"\u001b[39m\u001b[38;5;124mseed\u001b[39m\u001b[38;5;124m\"\u001b[39m: seed,\n\u001b[0;32m   1215\u001b[0m                 \u001b[38;5;124m\"\u001b[39m\u001b[38;5;124mservice_tier\u001b[39m\u001b[38;5;124m\"\u001b[39m: service_tier,\n\u001b[0;32m   1216\u001b[0m                 \u001b[38;5;124m\"\u001b[39m\u001b[38;5;124mstop\u001b[39m\u001b[38;5;124m\"\u001b[39m: stop,\n\u001b[0;32m   1217\u001b[0m                 \u001b[38;5;124m\"\u001b[39m\u001b[38;5;124mstore\u001b[39m\u001b[38;5;124m\"\u001b[39m: store,\n\u001b[0;32m   1218\u001b[0m                 \u001b[38;5;124m\"\u001b[39m\u001b[38;5;124mstream\u001b[39m\u001b[38;5;124m\"\u001b[39m: stream,\n\u001b[0;32m   1219\u001b[0m                 \u001b[38;5;124m\"\u001b[39m\u001b[38;5;124mstream_options\u001b[39m\u001b[38;5;124m\"\u001b[39m: stream_options,\n\u001b[0;32m   1220\u001b[0m                 \u001b[38;5;124m\"\u001b[39m\u001b[38;5;124mtemperature\u001b[39m\u001b[38;5;124m\"\u001b[39m: temperature,\n\u001b[0;32m   1221\u001b[0m                 \u001b[38;5;124m\"\u001b[39m\u001b[38;5;124mtool_choice\u001b[39m\u001b[38;5;124m\"\u001b[39m: tool_choice,\n\u001b[0;32m   1222\u001b[0m                 \u001b[38;5;124m\"\u001b[39m\u001b[38;5;124mtools\u001b[39m\u001b[38;5;124m\"\u001b[39m: tools,\n\u001b[0;32m   1223\u001b[0m                 \u001b[38;5;124m\"\u001b[39m\u001b[38;5;124mtop_logprobs\u001b[39m\u001b[38;5;124m\"\u001b[39m: top_logprobs,\n\u001b[0;32m   1224\u001b[0m                 \u001b[38;5;124m\"\u001b[39m\u001b[38;5;124mtop_p\u001b[39m\u001b[38;5;124m\"\u001b[39m: top_p,\n\u001b[0;32m   1225\u001b[0m                 \u001b[38;5;124m\"\u001b[39m\u001b[38;5;124muser\u001b[39m\u001b[38;5;124m\"\u001b[39m: user,\n\u001b[0;32m   1226\u001b[0m                 \u001b[38;5;124m\"\u001b[39m\u001b[38;5;124mverbosity\u001b[39m\u001b[38;5;124m\"\u001b[39m: verbosity,\n\u001b[0;32m   1227\u001b[0m                 \u001b[38;5;124m\"\u001b[39m\u001b[38;5;124mweb_search_options\u001b[39m\u001b[38;5;124m\"\u001b[39m: web_search_options,\n\u001b[0;32m   1228\u001b[0m             },\n\u001b[0;32m   1229\u001b[0m             completion_create_params\u001b[38;5;241m.\u001b[39mCompletionCreateParamsStreaming\n\u001b[0;32m   1230\u001b[0m             \u001b[38;5;28;01mif\u001b[39;00m stream\n\u001b[0;32m   1231\u001b[0m             \u001b[38;5;28;01melse\u001b[39;00m completion_create_params\u001b[38;5;241m.\u001b[39mCompletionCreateParamsNonStreaming,\n\u001b[0;32m   1232\u001b[0m         ),\n\u001b[0;32m   1233\u001b[0m         options\u001b[38;5;241m=\u001b[39mmake_request_options(\n\u001b[0;32m   1234\u001b[0m             extra_headers\u001b[38;5;241m=\u001b[39mextra_headers, extra_query\u001b[38;5;241m=\u001b[39mextra_query, extra_body\u001b[38;5;241m=\u001b[39mextra_body, timeout\u001b[38;5;241m=\u001b[39mtimeout\n\u001b[0;32m   1235\u001b[0m         ),\n\u001b[0;32m   1236\u001b[0m         cast_to\u001b[38;5;241m=\u001b[39mChatCompletion,\n\u001b[0;32m   1237\u001b[0m         stream\u001b[38;5;241m=\u001b[39mstream \u001b[38;5;129;01mor\u001b[39;00m \u001b[38;5;28;01mFalse\u001b[39;00m,\n\u001b[0;32m   1238\u001b[0m         stream_cls\u001b[38;5;241m=\u001b[39mStream[ChatCompletionChunk],\n\u001b[0;32m   1239\u001b[0m     )\n",
      "File \u001b[1;32m~\\anaconda3\\Lib\\site-packages\\openai\\_base_client.py:1259\u001b[0m, in \u001b[0;36mSyncAPIClient.post\u001b[1;34m(self, path, cast_to, body, options, files, stream, stream_cls)\u001b[0m\n\u001b[0;32m   1245\u001b[0m \u001b[38;5;28;01mdef\u001b[39;00m \u001b[38;5;21mpost\u001b[39m(\n\u001b[0;32m   1246\u001b[0m     \u001b[38;5;28mself\u001b[39m,\n\u001b[0;32m   1247\u001b[0m     path: \u001b[38;5;28mstr\u001b[39m,\n\u001b[1;32m   (...)\u001b[0m\n\u001b[0;32m   1254\u001b[0m     stream_cls: \u001b[38;5;28mtype\u001b[39m[_StreamT] \u001b[38;5;241m|\u001b[39m \u001b[38;5;28;01mNone\u001b[39;00m \u001b[38;5;241m=\u001b[39m \u001b[38;5;28;01mNone\u001b[39;00m,\n\u001b[0;32m   1255\u001b[0m ) \u001b[38;5;241m-\u001b[39m\u001b[38;5;241m>\u001b[39m ResponseT \u001b[38;5;241m|\u001b[39m _StreamT:\n\u001b[0;32m   1256\u001b[0m     opts \u001b[38;5;241m=\u001b[39m FinalRequestOptions\u001b[38;5;241m.\u001b[39mconstruct(\n\u001b[0;32m   1257\u001b[0m         method\u001b[38;5;241m=\u001b[39m\u001b[38;5;124m\"\u001b[39m\u001b[38;5;124mpost\u001b[39m\u001b[38;5;124m\"\u001b[39m, url\u001b[38;5;241m=\u001b[39mpath, json_data\u001b[38;5;241m=\u001b[39mbody, files\u001b[38;5;241m=\u001b[39mto_httpx_files(files), \u001b[38;5;241m*\u001b[39m\u001b[38;5;241m*\u001b[39moptions\n\u001b[0;32m   1258\u001b[0m     )\n\u001b[1;32m-> 1259\u001b[0m     \u001b[38;5;28;01mreturn\u001b[39;00m cast(ResponseT, \u001b[38;5;28mself\u001b[39m\u001b[38;5;241m.\u001b[39mrequest(cast_to, opts, stream\u001b[38;5;241m=\u001b[39mstream, stream_cls\u001b[38;5;241m=\u001b[39mstream_cls))\n",
      "File \u001b[1;32m~\\anaconda3\\Lib\\site-packages\\openai\\_base_client.py:1047\u001b[0m, in \u001b[0;36mSyncAPIClient.request\u001b[1;34m(self, cast_to, options, stream, stream_cls)\u001b[0m\n\u001b[0;32m   1044\u001b[0m             err\u001b[38;5;241m.\u001b[39mresponse\u001b[38;5;241m.\u001b[39mread()\n\u001b[0;32m   1046\u001b[0m         log\u001b[38;5;241m.\u001b[39mdebug(\u001b[38;5;124m\"\u001b[39m\u001b[38;5;124mRe-raising status error\u001b[39m\u001b[38;5;124m\"\u001b[39m)\n\u001b[1;32m-> 1047\u001b[0m         \u001b[38;5;28;01mraise\u001b[39;00m \u001b[38;5;28mself\u001b[39m\u001b[38;5;241m.\u001b[39m_make_status_error_from_response(err\u001b[38;5;241m.\u001b[39mresponse) \u001b[38;5;28;01mfrom\u001b[39;00m \u001b[38;5;28;01mNone\u001b[39;00m\n\u001b[0;32m   1049\u001b[0m     \u001b[38;5;28;01mbreak\u001b[39;00m\n\u001b[0;32m   1051\u001b[0m \u001b[38;5;28;01massert\u001b[39;00m response \u001b[38;5;129;01mis\u001b[39;00m \u001b[38;5;129;01mnot\u001b[39;00m \u001b[38;5;28;01mNone\u001b[39;00m, \u001b[38;5;124m\"\u001b[39m\u001b[38;5;124mcould not resolve response (should never happen)\u001b[39m\u001b[38;5;124m\"\u001b[39m\n",
      "\u001b[1;31mRateLimitError\u001b[0m: Error code: 429 - {'error': {'message': 'You exceeded your current quota, please check your plan and billing details. For more information on this error, read the docs: https://platform.openai.com/docs/guides/error-codes/api-errors.', 'type': 'insufficient_quota', 'param': None, 'code': 'insufficient_quota'}}"
     ]
    }
   ],
   "source": [
    "simple_demo()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "8c8ff4af-932b-4c4d-9755-0ebcd09fa310",
   "metadata": {},
   "outputs": [],
   "source": []
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "18252200-4e1c-46df-90bb-70a621cd4410",
   "metadata": {},
   "outputs": [],
   "source": []
  }
 ],
 "metadata": {
  "kernelspec": {
   "display_name": "Python 3 (ipykernel)",
   "language": "python",
   "name": "python3"
  },
  "language_info": {
   "codemirror_mode": {
    "name": "ipython",
    "version": 3
   },
   "file_extension": ".py",
   "mimetype": "text/x-python",
   "name": "python",
   "nbconvert_exporter": "python",
   "pygments_lexer": "ipython3",
   "version": "3.12.4"
  }
 },
 "nbformat": 4,
 "nbformat_minor": 5
}
